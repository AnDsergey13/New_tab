<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Новая вкладка</title>
  <link rel="icon" type="image/png" href="icons/librewolf128.png">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" defer></script>
  <style>
    :root{
      --bookmark-size: 100px;
      --bg-color: #1a1a1a;
      --card-bg: #2d2d2d;
      --text-color: #f0f0f0;
      --accent-color: #4a9eff;
      --grid-columns: 8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      height:100vh;overflow:hidden;
    }
    .container{display:flex;flex-direction:column;height:100vh;padding:20px;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .controls{display:flex;gap:8px;align-items:center;}
    button{background:var(--accent-color);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,.06)}
    .bookmarks-container{
        flex:1;
        overflow:auto;
        padding:10px;
        border-radius:8px;
        background:rgba(0,0,0,.12);
        display:flex;
        justify-content:center;    /* центрируем саму сетку внутри контейнера */
        align-items:center;        /* при желании вертикально центрировать, можно убрать */
    }

    /* переменная для промежутка между плитками — удобно потом менять */
    :root { --grid-gap: 12px; }

    .bookmarks-grid{
        display:grid;
        gap:var(--grid-gap);
        align-content:start;
        /* фиксированная ширина каждой колонки — расстояния будут постоянными */
        grid-template-columns: repeat(var(--grid-columns), var(--bookmark-size));
        /* сетка не растягивается на 100% — она «shrink-wrap» по содержимому */
        width: auto;
        max-width: none;
        justify-content: center; /* при лишней ширине центрируем колонки внутри grid */
        grid-auto-rows: var(--bookmark-size); /* строки той же высоты для ровного вида */
    }
    .bookmark{
      background:var(--card-bg);border-radius:8px;padding:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;
      height:var(--bookmark-size);width:var(--bookmark-size);cursor:pointer;position:relative;box-shadow:0 4px 8px rgba(0,0,0,.3);
      transition:transform .16s,box-shadow .16s;
    }
    .bookmark:hover{transform:translateY(-4px);box-shadow:0 10px 18px rgba(0,0,0,.45)}
    .bookmark img{width:50%;height:50%;object-fit:contain;margin-bottom:8px}
    .bookmark-title{font-size:12px;text-align:center;overflow:hidden;text-overflow:ellipsis;width:100%}
    .edit-btn{position:absolute;top:6px;right:6px;width:26px;height:26px;border-radius:4px;background:transparent;border:none;opacity:0;cursor:pointer;padding:0}
    .bookmark:hover .edit-btn{opacity:1}
    .edit-btn img{width:16px;height:16px;pointer-events:none}
    .add-bookmark{border:2px dashed var(--accent-color);background:rgba(74,158,255,.06);font-size:28px;display:flex;align-items:center;justify-content:center;color:var(--accent-color)}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:var(--card-bg);padding:18px;border-radius:8px;width:420px;max-width:96%}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .form-group{margin-bottom:12px}
    label{display:block;margin-bottom:6px}
    input[type="text"],input[type="url"],select{width:100%;padding:8px;border-radius:6px;border:1px solid #555;background:#333;color:var(--text-color)}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .notification{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:6px;background:var(--accent-color);color:#fff;z-index:2000;opacity:0;transition:opacity .25s}
    .notification.show{opacity:1}
    /* Ghost/drag classes from Sortable */
    .sortable-ghost{opacity:.4;background:#4a4a4a}
    .sortable-drag{opacity:.5}
    input[type="range"]{width:100%}
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="header">
      <h1 aria-hidden="true"></h1>
      <div class="controls" role="toolbar">
        <button id="add-bookmark">Добавить ярлык</button>
        <button id="settings-btn" class="ghost">Настройки</button>
        <button id="export-btn" class="ghost">Экспорт</button>
        <button id="import-btn" class="ghost">Импорт</button>
        <input id="import-file" type="file" accept=".json" style="display:none">
      </div>
    </div>

    <div class="bookmarks-container">
      <div class="bookmarks-grid" id="bookmarks-grid" aria-live="polite"></div>
    </div>
  </div>

  <!-- Edit / Add Modal -->
  <div class="modal" id="edit-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Редактирование</h2>
        <button id="close-modal" aria-label="Закрыть">&times;</button>
      </div>
      <form id="bookmark-form">
        <div class="form-group">
          <label for="bookmark-title-input">Название</label>
          <input id="bookmark-title-input" type="text" required />
        </div>
        <div class="form-group">
          <label for="bookmark-url-input">URL</label>
          <input id="bookmark-url-input" type="url" required />
        </div>
        <div class="form-group">
          <label for="bookmark-icon-input">Иконка (URL или оставить пустым)</label>
          <input id="bookmark-icon-input" type="text" placeholder="Оставьте пустым для авто-иконки" />
        </div>
        <div class="form-actions">
          <button type="button" id="delete-bookmark" class="ghost">Удалить</button>
          <button type="submit">Сохранить</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settings-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Настройки сетки</h2>
        <button id="close-settings" aria-label="Закрыть">&times;</button>
      </div>
      <div class="form-group">
        <label for="columns-slider">Количество столбцов: <span id="columns-value">8</span></label>
        <input id="columns-slider" type="range" min="4" max="20" value="8" />
      </div>
      <div class="form-actions">
        <button id="save-settings">Сохранить</button>
      </div>
    </div>
  </div>

  <div class="notification" id="notification" role="status" aria-live="polite"></div>

  <script>
  'use strict';

  // ---- Utilities ----
  const $ = selector => document.querySelector(selector);
  const $$ = selector => Array.from(document.querySelectorAll(selector));

  function uid() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  }

  function debounce(fn, wait = 200) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
  }

  // safer URL -> favicon providers with fallback
  function bestFavicon(url) {
    try {
      const u = new URL(url);
      const encoded = encodeURIComponent(url);
      // try google (high res) then duckduckgo, then default placeholder
      return `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&url=${encoded}&size=256`;
    } catch (e) {
      return '';
    }
  }

  // ---- App State & Selectors ----
  const state = {
    bookmarks: [],
    currentEditId: null,
    gridColumns: parseInt(localStorage.getItem('gridColumns')) || 8
  };

  const els = {
    bookmarksGrid: $('#bookmarks-grid'),
    addBtn: $('#add-bookmark'),
    settingsBtn: $('#settings-btn'),
    exportBtn: $('#export-btn'),
    importBtn: $('#import-btn'),
    importFile: $('#import-file'),
    editModal: $('#edit-modal'),
    settingsModal: $('#settings-modal'),
    closeModal: $('#close-modal'),
    closeSettings: $('#close-settings'),
    bookmarkForm: $('#bookmark-form'),
    deleteBtn: $('#delete-bookmark'),
    modalTitle: $('#modal-title'),
    notif: $('#notification'),
    columnsSlider: $('#columns-slider'),
    columnsValue: $('#columns-value'),
    saveSettingsBtn: $('#save-settings'),
    titleInput: $('#bookmark-title-input'),
    urlInput: $('#bookmark-url-input'),
    iconInput: $('#bookmark-icon-input')
  };

  // debounce saving to localStorage
  const saveToLocalStorage = debounce(() => {
    localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
  }, 150);

  // ---- Initialization ----
  function init(){
    loadState();
    applyGridSettings();
    bindUI();
    renderBookmarks();
    setupSortable();
  }

  function loadState(){
    const loaded = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    // keep shape: each bookmark {id, title, url, icon}
    state.bookmarks = Array.isArray(loaded) ? loaded.map(b => ({ id: b.id || uid(), title: b.title||'', url: b.url||'', icon: b.icon||'' })) : [];
  }

  // ---- Rendering ----
  function renderBookmarks(){
    const grid = els.bookmarksGrid;
    grid.innerHTML = '';
    // render items in order of state.bookmarks
    state.bookmarks.forEach(b => {
      const el = createBookmarkElement(b);
      grid.appendChild(el);
    });
    // add bookmark "add" tile
    const addTile = document.createElement('div');
    addTile.className = 'bookmark add-bookmark';
    addTile.setAttribute('data-action','add');
    addTile.setAttribute('role','button');
    addTile.title = 'Добавить ярлык';
    addTile.textContent = '+';
    grid.appendChild(addTile);
  }

  function createBookmarkElement(bookmark){
    const el = document.createElement('div');
    el.className = 'bookmark';
    el.dataset.id = bookmark.id;

    // store attributes for export convenience
    el.dataset.title = bookmark.title;
    el.dataset.url = bookmark.url;
    el.dataset.icon = bookmark.icon || '';

    const img = document.createElement('img');
    img.alt = bookmark.title || 'icon';
    img.src = bookmark.icon || bestFavicon(bookmark.url) || 'https://picsum.photos/seed/default/50/50.jpg';
    img.addEventListener('error', () => {
      // fallback provider
      img.src = `https://icons.duckduckgo.com/ip3/${new URL(bookmark.url).hostname}.ico`;
      // if still fails, set a placeholder after short delay
      setTimeout(()=> { if (!img.complete || img.naturalWidth === 0) img.src = 'https://picsum.photos/seed/default/50/50.jpg'; }, 600);
    });

    const title = document.createElement('div');
    title.className = 'bookmark-title';
    title.textContent = bookmark.title || bookmark.url;

    const editBtn = document.createElement('button');
    editBtn.className = 'edit-btn';
    editBtn.title = 'Редактировать';
    editBtn.innerHTML = `<img src="icons/pencil.svg" alt="edit">`;
    editBtn.dataset.action = 'edit';

    el.appendChild(img);
    el.appendChild(title);
    el.appendChild(editBtn);

    return el;
  }

  // ---- Sortable setup ----
  function setupSortable(){
    new Sortable(els.bookmarksGrid, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      dragClass: 'sortable-drag',
      filter: '.add-bookmark',
      onEnd: (evt) => {
        // rebuild state.bookmarks according to DOM order (skip add-bookmark)
        const ids = Array.from(els.bookmarksGrid.children)
          .filter(ch => !ch.classList.contains('add-bookmark'))
          .map(ch => ch.dataset.id);
        const newOrder = ids.map(id => state.bookmarks.find(b => b.id === id)).filter(Boolean);
        state.bookmarks = newOrder;
        saveToLocalStorage();
        // re-render to update data-attributes consistently
        renderBookmarks();
      }
    });
  }

  // ---- UI Bindings (delegation where possible) ----
  function bindUI(){
    // main controls
    els.addBtn.addEventListener('click', () => openModalForAdd());
    els.settingsBtn.addEventListener('click', openSettingsModal);
    els.exportBtn.addEventListener('click', exportBookmarks);
    els.importBtn.addEventListener('click', () => els.importFile.click());
    els.importFile.addEventListener('change', importBookmarks);
    els.closeModal.addEventListener('click', closeEditModal);
    els.closeSettings.addEventListener('click', closeSettingsModal);
    els.saveSettingsBtn.addEventListener('click', saveGridSettings);
    els.columnsSlider.addEventListener('input', (e) => {
      els.columnsValue.textContent = e.target.value;
      document.documentElement.style.setProperty('--grid-columns', e.target.value);
    });

    // delegated clicks inside grid
    els.bookmarksGrid.addEventListener('click', (e) => {
      const target = e.target;
      const tile = target.closest('.bookmark');
      if (!tile) return;
      if (tile.classList.contains('add-bookmark') || tile.dataset.action === 'add') {
        openModalForAdd();
        return;
      }
      // edit button
      if (target.closest('.edit-btn') || target.dataset.action === 'edit') {
        const id = tile.dataset.id;
        openModalForEdit(id);
        return;
      }
      // click on tile -> navigate
      const id = tile.dataset.id;
      const bookmark = state.bookmarks.find(b => b.id === id);
      if (bookmark && bookmark.url) {
        window.location.href = bookmark.url;
      }
    });

    // middle click opens in new tab
    els.bookmarksGrid.addEventListener('auxclick', (e) => {
      if (e.button !== 1) return;
      const tile = e.target.closest('.bookmark');
      if (!tile || tile.classList.contains('add-bookmark')) return;
      const bookmark = state.bookmarks.find(b => b.id === tile.dataset.id);
      if (bookmark && bookmark.url) window.open(bookmark.url, '_blank');
    });

    // form submit
    els.bookmarkForm.addEventListener('submit', (e) => {
      e.preventDefault();
      saveBookmarkFromForm();
    });

    els.deleteBtn.addEventListener('click', () => {
      if (!state.currentEditId) return;
      state.bookmarks = state.bookmarks.filter(b => b.id !== state.currentEditId);
      state.currentEditId = null;
      saveToLocalStorage();
      renderBookmarks();
      closeEditModal();
      showNotification('Ярлык удален');
    });

    // keyboard: ESC closes modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeEditModal();
        closeSettingsModal();
      }
    });

    // Ctrl + wheel — scale tile size
    document.addEventListener('wheel', (e) => {
      if (!e.ctrlKey) return;
      e.preventDefault();
      const sizeStr = getComputedStyle(document.documentElement).getPropertyValue('--bookmark-size').trim().replace('px','');
      const size = parseInt(sizeStr) || 100;
      const newSize = e.deltaY < 0 ? Math.min(size + 10, 200) : Math.max(size - 10, 60);
      document.documentElement.style.setProperty('--bookmark-size', newSize + 'px');
    }, { passive: false });
  }

  // ---- Modal helpers ----
  function openModalForAdd(){
    state.currentEditId = null;
    els.modalTitle.textContent = 'Добавление ярлыка';
    els.bookmarkForm.reset();
    els.deleteBtn.style.display = 'none';
    showModal(els.editModal);
  }

  function openModalForEdit(id){
    const bookmark = state.bookmarks.find(b => b.id === id);
    if (!bookmark) return;
    state.currentEditId = id;
    els.modalTitle.textContent = 'Редактирование ярлыка';
    els.titleInput.value = bookmark.title;
    els.urlInput.value = bookmark.url;
    els.iconInput.value = bookmark.icon || '';
    els.deleteBtn.style.display = 'block';
    showModal(els.editModal);
  }

  function showModal(modal){
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    // focus first input for accessibility
    setTimeout(()=> els.titleInput.focus(), 100);
  }

  function closeEditModal(){
    els.editModal.classList.remove('show');
    els.editModal.setAttribute('aria-hidden','true');
  }

  function openSettingsModal(){
    els.columnsSlider.value = state.gridColumns;
    els.columnsValue.textContent = state.gridColumns;
    showModal(els.settingsModal);
  }

  function closeSettingsModal(){
    els.settingsModal.classList.remove('show');
    els.settingsModal.setAttribute('aria-hidden','true');
  }

  function saveGridSettings(){
    const v = parseInt(els.columnsSlider.value);
    state.gridColumns = v;
    localStorage.setItem('gridColumns', v);
    document.documentElement.style.setProperty('--grid-columns', v);
    closeSettingsModal();
    showNotification('Настройки сохранены');
  }

  function applyGridSettings(){
    document.documentElement.style.setProperty('--grid-columns', state.gridColumns);
    els.columnsSlider.value = state.gridColumns;
    els.columnsValue.textContent = state.gridColumns;
  }

  // ---- Bookmark CRUD ----
  function saveBookmarkFromForm(){
    const title = els.titleInput.value.trim();
    const url = els.urlInput.value.trim();
    const icon = els.iconInput.value.trim();

    if (!title || !url) {
      showNotification('Название и URL обязательны', true);
      return;
    }

    if (state.currentEditId) {
      // update
      state.bookmarks = state.bookmarks.map(b => b.id === state.currentEditId ? { ...b, title, url, icon: icon || b.icon || bestFavicon(url) } : b);
      showNotification('Ярлык обновлен');
    } else {
      // add
      const newBookmark = { id: uid(), title, url, icon: icon || bestFavicon(url) };
      state.bookmarks.push(newBookmark);
      showNotification('Ярлык сохранен');
    }

    saveToLocalStorage();
    renderBookmarks();
    closeEditModal();
  }

  // ---- Import / Export ----
  function exportBookmarks(){
    // export in shown order
    const items = state.bookmarks.map(b => ({ title: b.title, url: b.url, icon: b.icon }));
    const dataStr = JSON.stringify(items, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const now = new Date().toISOString().replace(/:/g,'-').replace('T','_').slice(0, -5);
    a.href = url;
    a.download = `bookmarks_${now}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showNotification('Ярлыки экспортированы');
  }

  function importBookmarks(e){
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try {
        const parsed = JSON.parse(evt.target.result);
        if (!Array.isArray(parsed)) throw new Error('Файл должен быть массивом ярлыков');
        // normalize and replace
        state.bookmarks = parsed.map(b => ({ id: b.id || uid(), title: b.title || '', url: b.url || '', icon: b.icon || '' }));
        saveToLocalStorage();
        renderBookmarks();
        showNotification('Ярлыки импортированы');
      } catch (err) {
        showNotification('Ошибка при импорте: ' + (err.message || err), true);
      } finally {
        // reset file input to allow re-import same file later
        els.importFile.value = '';
      }
    };
    reader.readAsText(file);
  }

  // ---- Notifications ----
  let notifTimer = null;
  function showNotification(message, isError = false){
    const n = els.notif;
    n.textContent = message;
    n.style.backgroundColor = isError ? '#e74c3c' : '';
    n.classList.add('show');
    clearTimeout(notifTimer);
    notifTimer = setTimeout(()=> n.classList.remove('show'), 3000);
  }

  // start app
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
